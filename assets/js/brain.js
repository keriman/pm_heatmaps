let currentSectorName="",currentFilteredData=[],currentTipoMap={},currentTiposArray=[],currentSectorLayer=null;!function(){const e={open:!1},t=new Image;Object.defineProperty(t,"id",{get:function(){e.open=!0}}),setInterval((function(){console.clear()}),1e3),document.addEventListener("contextmenu",(e=>e.preventDefault())),document.addEventListener("keydown",(function(e){if("F12"===e.key||e.ctrlKey&&e.shiftKey&&("I"===e.key||"J"===e.key||"C"===e.key)||e.ctrlKey&&("u"===e.key||"U"===e.key||"s"===e.key||"S"===e.key))return e.preventDefault(),!1}));let o=!1;setInterval((function(){const e=window.outerWidth-window.innerWidth>160,t=window.outerHeight-window.innerHeight>160;e||t?o||(o=!0):o=!1}),500),"undefined"!=typeof cuadrantesKML&&"undefined"!=typeof sectoresKML&&(Object.defineProperty(window,"cuadrantesKML",{get:function(){},set:function(){}}),Object.defineProperty(window,"sectoresKML",{get:function(){},set:function(){}}))}(),document.addEventListener("DOMContentLoaded",(function(){const e=L.map("map").setView([19.70295700755723,-101.19324799043297],11);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(e);const t={Centro:"#FF1493",Independencia:"#00BFFF","Independencia Sur":"#32CD32","Nueva España":"#FFD700","República":"#FF4500","República Poniente":"#9370DB","Revolución":"#00CED1"},o=L.layerGroup().addTo(e),n=new Blob([cuadrantesKML],{type:"application/vnd.google-earth.kml+xml"}),l=URL.createObjectURL(n),a=L.geoJson(null,{style:function(e){return{color:"#000000",weight:2,opacity:.8,fillOpacity:0,fillColor:"transparent"}},onEachFeature:function(e,t){const o=e.properties.nombre||"Sin nombre",n=e.properties.nom_sec||"";t.bindPopup(`<b>Cuadrante: ${o}</b><br>Sector: ${n}`)}});omnivore.kml(l,null,a).on("ready",(function(){this.addTo(o),URL.revokeObjectURL(l)}));const r=L.layerGroup().addTo(e),i=new Blob([sectoresKML],{type:"application/vnd.google-earth.kml+xml"}),s=URL.createObjectURL(i),c=L.geoJson(null,{style:function(e){const o=e.properties.nombre||"Sin nombre",n=t[o]||"#808080";return{color:n,weight:4,opacity:1,fillOpacity:.35,fillColor:n}},onEachFeature:function(e,o){const n=e.properties.nombre||"Sin nombre",l=e.properties.responsable||"",a=t[n]||"#808080";o.bindPopup(`<b>Sector: ${n}</b><br>Responsable: ${l}<br><span style="color:${a}">●</span> Color identificador`),o.on("click",(function(e){L.DomEvent.stopPropagation(e);const t=M(o);!function(e,t,o){const n=document.getElementById("sectorDataModalLabel"),l=document.getElementById("sectorDataContent"),a=document.getElementById("incidentesChart"),r=document.getElementById("exportBtn");currentSectorName=e,currentFilteredData=t,currentSectorLayer=o;const i=N(e);n.textContent=`Datos del Sector: ${i}`,h&&(h.destroy(),h=null);if(a.style.display="none",0===t.length)l.innerHTML='<p class="text-muted">No hay datos disponibles para este sector.</p>',a.parentElement.style.display="none",r.style.display="none";else{r.style.display="inline-block",currentTipoMap={},currentTiposArray=[],t.forEach((e=>{const t=N(e.tipo||"Sin tipo"),o=e.fecha?e.fecha.toLocaleDateString("es-MX"):"Sin fecha",n=e.calle||"Sin información",l=e.colonia||"Sin información",a=e.folio||"Sin folio";currentTipoMap[t]||(currentTipoMap[t]={count:0,incidents:[]},currentTiposArray.push(t)),currentTipoMap[t].count++,currentTipoMap[t].incidents.push({fecha:o,calle:n,colonia:l,tipo:t,folio:a})})),currentTiposArray.sort(((e,t)=>currentTipoMap[t].count-currentTipoMap[e].count));let e=`\n                <div class="mb-4">\n                    <div class="alert alert-info">\n                        <i class="bi bi-info-circle"></i> \n                        <strong>Total de incidentes:</strong> ${t.length}\n                    </div>\n                </div>\n                \n                <div class="accordion" id="incidentesAccordion">\n            `;currentTiposArray.forEach(((t,o)=>{const n=currentTipoMap[t],l=`collapse-${o}`;e+=`\n                    <div class="accordion-item">\n                        <h2 class="accordion-header" id="heading-${o}">\n                            <button class="accordion-button ${0===o?"":"collapsed"}" type="button" \n                                    data-bs-toggle="collapse" data-bs-target="#${l}" \n                                    aria-expanded="${0===o?"true":"false"}" \n                                    aria-controls="${l}">\n                                <span class="badge bg-primary me-2">${n.count}</span>\n                                <strong>${t}</strong>\n                            </button>\n                        </h2>\n                        <div id="${l}" class="accordion-collapse collapse ${0===o?"show":""}" \n                             aria-labelledby="heading-${o}" data-bs-parent="#incidentesAccordion">\n                            <div class="accordion-body">\n                                <div class="table-responsive">\n                                    <table class="table table-sm table-hover">\n                                        <thead>\n                                            <tr>\n                                                <th>Folio</th>\n                                                <th>Fecha</th>\n                                                <th>Calle</th>\n                                                <th>Colonia</th>\n                                                <th>Tipo</th>\n                                            </tr>\n                                        </thead>\n                                        <tbody>\n                `,n.incidents.forEach((t=>{e+=`\n                        <tr>\n                            <td><span class="badge bg-info">${t.folio}</span></td>\n                            <td>${t.fecha}</td>\n                            <td>${t.calle}</td>\n                            <td>${t.colonia}</td>\n                            <td><span class="badge bg-secondary">${t.tipo}</span></td>\n                        </tr>\n                    `})),e+="\n                                        </tbody>\n                                    </table>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                "})),e+="</div>",l.innerHTML=e,a.style.display="block",a.parentElement.style.display="flex";const o=a.getContext("2d"),n=currentTiposArray,i=currentTiposArray.map((e=>currentTipoMap[e].count)),s=n.map(((e,t)=>`hsl(${360*t/n.length%360}, 70%, 65%)`)),c=n.map(((e,t)=>`hsl(${360*t/n.length%360}, 70%, 40%)`));h=new Chart(o,{type:"pie",data:{labels:n,datasets:[{data:i,backgroundColor:s,borderColor:c,borderWidth:2,hoverOffset:15}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},title:{display:!0,text:`Distribución de ${t.length} Incidentes`,font:{size:16},padding:{top:10,bottom:20}},tooltip:{callbacks:{label:function(e){const t=e.label||"",o=e.raw||0,n=e.dataset.data.reduce(((e,t)=>e+t),0);return`${t}: ${o} incidentes (${Math.round(o/n*100)}%)`}}}}}});const d=document.getElementById("chartLegendContainer");d.innerHTML="";const p=i.reduce(((e,t)=>e+t),0);n.forEach(((e,t)=>{const o=i[t],n=p>0?Math.round(o/p*100):0,l=s[t],a=document.createElement("div");a.className="col-12 mb-2",a.innerHTML=`\n                    <div class="d-flex align-items-center p-2 border rounded" style="background-color: #f8f9fa;">\n                        <div style="width: 20px; height: 20px; background-color: ${l}; border: 2px solid ${c[t]}; border-radius: 50%; flex-shrink: 0;"></div>\n                        <div class="ms-2 flex-grow-1">\n                            <div style="font-size: 12px; font-weight: 500;">${e}</div>\n                            <div style="font-size: 11px; color: #6c757d;">${o} incidentes (${n}%)</div>\n                        </div>\n                    </div>\n                `,d.appendChild(a)})),function(){const e=document.getElementById("exportBtn");e.onclick=async function(){try{const t=e.innerHTML;e.innerHTML='<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Exportando...',e.disabled=!0;const o=new ExcelJS.Workbook;o.creator="Visor de Mapas de Calor",o.created=new Date;const n=o.addWorksheet("Incidentes");n.mergeCells("A1:G1");const l=n.getCell("A1");l.value=`ANÁLISIS DE INCIDENTES - SECTOR: ${currentSectorName.toUpperCase()}`,l.font={bold:!0,size:16,color:{argb:"FFFFFFFF"}},l.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF2E86C1"}},l.alignment={horizontal:"center",vertical:"middle"},n.getCell("A3").value="Fecha de generación:",n.getCell("B3").value=(new Date).toLocaleString("es-MX"),n.getCell("B3").numFmt="dd/mm/yyyy hh:mm:ss",n.getCell("A4").value="Total de incidentes:",n.getCell("B4").value=currentFilteredData.length,n.getCell("B4").font={bold:!0},n.getCell("A5").value="Sector analizado:",n.getCell("B5").value=currentSectorName;let a=7;n.getCell(`A${a}`).value="RESUMEN POR TIPO DE INCIDENTE",n.getCell(`A${a}`).font={bold:!0,size:14},n.mergeCells(`A${a}:G${a}`),a++,n.getRow(a).values=["Tipo de Incidente","Cantidad","Porcentaje","Color Asignado"];const r=n.getRow(a);r.font={bold:!0,color:{argb:"FFFFFFFF"}},r.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF3498DB"}};const i=currentFilteredData.length;currentTiposArray.forEach(((e,t)=>{a++;const o=currentTipoMap[e].count,l=i>0?(o/i*100).toFixed(2)+"%":"0%",r=O(360*t/Math.max(currentTiposArray.length,1)%360,70,65);n.getRow(a).values=[e,o,l,r];n.getCell(`D${a}`).fill={type:"pattern",pattern:"solid",fgColor:{argb:r.replace("#","FF")}}})),a+=2,n.getCell(`A${a}`).value="DETALLE COMPLETO DE INCIDENTES",n.getCell(`A${a}`).font={bold:!0,size:14},n.mergeCells(`A${a}:G${a}`),a++,n.getRow(a).values=["Folio","Tipo","Calle","Colonia","Fecha","Latitud","Longitud"];const s=n.getRow(a);s.font={bold:!0,color:{argb:"FFFFFFFF"}},s.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF27AE60"}},currentFilteredData.forEach((e=>{a++;const t=e.fecha?e.fecha.toLocaleDateString("es-MX"):"Sin fecha",o=e.point?e.point[0].toFixed(6):"N/A",l=e.point?e.point[1].toFixed(6):"N/A";n.getRow(a).values=[e.folio||"Sin folio",e.tipo||"Sin tipo",e.calle||"Sin información",e.colonia||"Sin información",t,o,l]}));const c=o.addWorksheet("Estadísticas");c.mergeCells("A1:D1");const d=c.getCell("A1");d.value=`ESTADÍSTICAS - SECTOR: ${currentSectorName.toUpperCase()}`,d.font={bold:!0,size:16},d.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF9B59B6"}},d.alignment={horizontal:"center"};let p=3;if([["Total de incidentes",currentFilteredData.length],["Tipos diferentes de incidentes",currentTiposArray.length],["Fecha de análisis",(new Date).toLocaleDateString("es-MX")],["Hora de generación",(new Date).toLocaleTimeString("es-MX")],["",""],["TIPO MÁS FRECUENTE","CANTIDAD","PORCENTAJE"]].forEach((([e,t,o])=>{c.getCell(`A${p}`).value=e,void 0!==t&&(c.getCell(`B${p}`).value=t,"Total de incidentes"===e&&(c.getCell(`B${p}`).font={bold:!0,size:14})),void 0!==o&&(c.getCell(`C${p}`).value=o),p++})),currentTiposArray.length>0){const e=currentTiposArray[0],t=currentTipoMap[e].count,o=(t/i*100).toFixed(2)+"%";c.getCell(`A${p}`).value=e,c.getCell(`B${p}`).value=t,c.getCell(`C${p}`).value=o,c.getCell(`A${p}`).font={bold:!0}}p+=2,c.getCell(`A${p}`).value="DISTRIBUCIÓN COMPLETA",c.getCell(`A${p}`).font={bold:!0,size:12},c.mergeCells(`A${p}:C${p}`),currentTiposArray.forEach(((e,t)=>{p++;const o=currentTipoMap[e].count,n=i>0?(o/i*100).toFixed(2)+"%":"0%";c.getRow(p).values=[e,o,n],t%2==0&&(c.getRow(p).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF8F9FA"}})})),n.columns=[{width:20},{width:25},{width:35},{width:25},{width:15},{width:15},{width:15}],c.columns=[{width:35},{width:15},{width:15}],n.views=[{state:"frozen",ySplit:10}];const u=o.addWorksheet("Gráfica");u.mergeCells("A1:H1");const g=u.getCell("A1");if(g.value=`GRÁFICA DE DISTRIBUCIÓN - SECTOR: ${currentSectorName.toUpperCase()}`,g.font={bold:!0,size:16,color:{argb:"FFFFFFFF"}},g.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF8E44AD"}},g.alignment={horizontal:"center",vertical:"middle"},u.getRow(1).height=30,h)try{const e=h.toBase64Image(),t=o.addImage({base64:e,extension:"png"});u.addImage(t,{tl:{col:.5,row:2.5},ext:{width:500,height:400}}),console.log("✓ Gráfica agregada al Excel exitosamente")}catch(e){console.error("Error al capturar la gráfica:",e),u.getCell("A3").value="Error: No se pudo capturar la gráfica"}else u.getCell("A3").value="No hay gráfica disponible para exportar";let m=3;u.getCell(`F${m}`).value="TIPOS DE INCIDENTES",u.getCell(`F${m}`).font={bold:!0,size:12},u.mergeCells(`F${m}:H${m}`),u.getCell(`F${m}`).alignment={horizontal:"center"},m+=2,u.getRow(m).values=["","","","","","Tipo de Incidente","Cantidad","Porcentaje"];u.getRow(m);["F","G","H"].forEach((e=>{const t=u.getCell(`${e}${m}`);t.font={bold:!0,color:{argb:"FFFFFFFF"}},t.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF667EEA"}},t.alignment={horizontal:"center",vertical:"middle"}})),currentTiposArray.forEach(((e,t)=>{m++;const o=currentTipoMap[e].count,n=i>0?(o/i*100).toFixed(1)+"%":"0%",l=O(360*t/Math.max(currentTiposArray.length,1)%360,70,65);u.getRow(m).values=["","","","","",e,o,n];const a=u.getCell(`F${m}`);a.fill={type:"pattern",pattern:"solid",fgColor:{argb:l.replace("#","FF")}},a.font={bold:!0},u.getCell(`G${m}`).alignment={horizontal:"center"},u.getCell(`H${m}`).alignment={horizontal:"center"},t%2==0&&["G","H"].forEach((e=>{u.getCell(`${e}${m}`).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF8F9FA"}}}))})),u.columns=[{width:3},{width:12},{width:12},{width:12},{width:3},{width:35},{width:12},{width:12}];const f=`Incidentes_${currentSectorName.replace(/[^a-zA-Z0-9áéíóúÁÉÍÓÚñÑ\s]/g,"").replace(/\s+/g,"_")}_${(new Date).toISOString().slice(0,10)}.xlsx`,y=await o.xlsx.writeBuffer(),b=new Blob([y],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});saveAs(b,f),e.innerHTML=t,e.disabled=!1,Alert.exportSuccess(f)}catch(t){console.error("Error al exportar:",t),e.innerHTML='<i class="bi bi-file-excel"></i> Exportar a Excel',e.disabled=!1;let o="Error al exportar el archivo";t.message.includes("exceljs")?o="Error con la librería de Excel. Por favor recarga la página.":t.message.includes("Blob")&&(o="Error al crear el archivo. Intenta con menos datos."),Alert.error("Error de Exportación",o)}}}()}new bootstrap.Modal(document.getElementById("sectorDataModal")).show();const s=document.getElementById("datos-tab"),c=document.getElementById("grafica-tab");s.classList.add("active"),c.classList.remove("active");const d=document.getElementById("datos-tab-pane"),p=document.getElementById("grafica-tab-pane");d.classList.add("show","active"),p.classList.remove("show","active")}(n,t,o)})),o.on("mouseover",(function(e){this.setStyle({weight:6,opacity:1})})),o.on("mouseout",(function(e){this.setStyle({weight:4,opacity:1})}))}});omnivore.kml(s,null,c).on("ready",(function(){this.addTo(r),y=c;const e=[];c.eachLayer((function(t){const o=t.feature.properties.nombre||"Sin nombre";e.includes(o)||e.push(o)})),e.sort().forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,B.appendChild(t)})),console.log("=== SECTORES CARGADOS ==="),c.eachLayer((function(e){const t=e.feature.properties.nombre||"Sin nombre",o=e.feature.geometry.type,n=e.getBounds();if(console.log(`Sector: ${t}, Tipo: ${o}`),console.log(`  Bounds: ${n.toBBoxString()}`),"MultiPolygon"===o)console.log(`  Número de polígonos: ${e.feature.geometry.coordinates.length}`);else if("GeometryCollection"===o){const t=e.feature.geometry.geometries;console.log(`  Número de geometrías: ${t.length}`),t.forEach(((e,t)=>{console.log(`    Geometría ${t+1}: ${e.type}`)}))}})),URL.revokeObjectURL(s)}));const d=L.control({position:"bottomright"});d.onAdd=function(e){const o=L.DomUtil.create("div","legend"),n=L.DomUtil.create("h4","",o);n.textContent="Sectores";const l=L.DomUtil.create("div","legend-content",o);for(const[e,o]of Object.entries(t))l.innerHTML+=`\n                <div class="legend-item">\n                    <span class="legend-color" style="background-color: ${o}"></span>\n                    <span>${e}</span>\n                </div>\n            `;return l.innerHTML+='<hr style="margin: 8px 0;"><div class="legend-item"><span class="legend-color" style="background-color: #000000; border-color: #000000;"></span><span>Cuadrantes (delineado)</span></div>',l.style.maxHeight=l.scrollHeight+"px",L.DomEvent.on(n,"click",(function(e){L.DomEvent.stopPropagation(e),l.classList.contains("collapsed")?(l.classList.remove("collapsed"),l.style.maxHeight=l.scrollHeight+"px"):l.classList.add("collapsed")})),L.DomEvent.disableClickPropagation(o),o},d.addTo(e);let p=null,u=L.layerGroup(),g=!0,m=[],f=[],y=null,h=null;const b=document.getElementById("fileInput"),v=document.getElementById("loader"),C=document.getElementById("heatmap-controls"),E=document.getElementById("filter-controls"),F=document.getElementById("radius"),S=document.getElementById("blur"),T=document.getElementById("radius-value"),w=document.getElementById("blur-value"),x=document.getElementById("startDate"),I=document.getElementById("endDate"),A=document.getElementById("tipoFilter"),B=document.getElementById("sectorFilter"),D=document.getElementById("filterBtn");function M(e){if(!m||0===m.length)return console.log("No hay datos para filtrar"),[];const t=e.feature.properties.nombre||"Sin nombre",o=e.feature.geometry.type;if(console.log(`Filtrando datos para sector: ${t}`),console.log(`Tipo de geometría: ${o}`),console.log(`Total de datos a filtrar: ${m.length}`),"GeometryCollection"===o){const t=e.feature.geometry.geometries;console.log(`  GeometryCollection con ${t.length} geometrías:`),t.forEach(((e,t)=>{console.log(`    ${t+1}. ${e.type}`)}))}let n=0,l=0;const a=m.filter((t=>{if(n++,!t.point)return!1;const o=L.latLng(t.point[0],t.point[1]);let a=!1;const r=e.feature.geometry.type;if("Polygon"===r){a=k(o,e.feature.geometry.coordinates[0].map((e=>L.latLng(e[1],e[0]))))}else if("MultiPolygon"===r)for(let t=0;t<e.feature.geometry.coordinates.length;t++){if(k(o,e.feature.geometry.coordinates[t][0].map((e=>L.latLng(e[1],e[0]))))){a=!0;break}}else if("GeometryCollection"===r){const t=e.feature.geometry.geometries;for(let e=0;e<t.length;e++){const n=t[e];if("Polygon"===n.type){if(k(o,n.coordinates[0].map((e=>L.latLng(e[1],e[0]))))){a=!0;break}}else if("MultiPolygon"===n.type){for(let e=0;e<n.coordinates.length;e++){if(k(o,n.coordinates[e][0].map((e=>L.latLng(e[1],e[0]))))){a=!0;break}}if(a)break}}}return a&&l++,a}));return console.log(`Puntos verificados: ${n}, Puntos dentro: ${l}`),console.log(`Datos filtrados para ${t}: ${a.length}`),a.length>0&&a.length<=5?(console.log("Puntos encontrados:"),a.forEach(((e,t)=>{console.log(`  ${t+1}. [${e.point[0]}, ${e.point[1]}] - ${e.tipo}`)}))):a.length>5&&(console.log(`Primeros 5 puntos de ${a.length}:`),a.slice(0,5).forEach(((e,t)=>{console.log(`  ${t+1}. [${e.point[0]}, ${e.point[1]}] - ${e.tipo}`)}))),a}function k(e,t){let o=!1;const n=e.lat,l=e.lng;for(let e=0,a=t.length-1;e<t.length;a=e++){const r=t[e].lat,i=t[e].lng,s=t[a].lat,c=t[a].lng;i>l!=c>l&&n<(s-r)*(l-i)/(c-i)+r&&(o=!o)}return o}function N(e){if(!e)return"";const t=String(e).toLowerCase();return t.charAt(0).toUpperCase()+t.slice(1)}function R(){if(p&&e.removeLayer(p),u.clearLayers(),0===f.length)return;const t=f.map((e=>e.point)).filter((e=>null!==e));0!==t.length&&(g?p=L.heatLayer(t,{radius:parseInt(F.value,10),blur:parseInt(S.value,10),maxZoom:18}).addTo(e):(f.forEach((e=>{if(e.point){const t=L.circleMarker([e.point[0],e.point[1]],{radius:6,fillColor:"#ff4444",color:"#cc0000",weight:1,opacity:1,fillOpacity:.8}),o=e.fecha?e.fecha.toLocaleDateString("es-MX"):"Sin fecha",n=`\n                        <div style="font-family: Arial, sans-serif; max-width: 300px;">\n                            <div style="margin-bottom: 8px;">\n                                <span style="font-weight: bold; color: #333; font-size: 14px;">\n                                    <i class="bi bi-file-earmark-text"></i> Folio: ${e.folio||"Sin folio"}\n                                </span>\n                            </div>\n                            <div style="border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 8px;">\n                                <span style="display: inline-block; background-color: #f0f0f0; padding: 4px 8px; \n                                       border-radius: 4px; font-weight: bold; color: #dc3545; font-size: 13px;">\n                                    <i class="bi bi-tag"></i> ${e.tipo||"Sin información"}\n                                </span>\n                            </div>\n                            <table style="width: 100%; font-size: 13px;">\n                                <tr>\n                                    <td style="padding: 4px 0; color: #666;"><i class="bi bi-geo-alt"></i> <strong>Calle:</strong></td>\n                                    <td style="padding: 4px 0;">${e.calle}</td>\n                                </tr>\n                                <tr>\n                                    <td style="padding: 4px 0; color: #666;"><i class="bi bi-buildings"></i> <strong>Colonia:</strong></td>\n                                    <td style="padding: 4px 0;">${e.colonia}</td>\n                                </tr>\n                                <tr>\n                                    <td style="padding: 4px 0; color: #666;"><i class="bi bi-calendar"></i> <strong>Fecha:</strong></td>\n                                    <td style="padding: 4px 0;">${o}</td>\n                                </tr>\n                            </table>\n                        </div>\n                    `;t.bindPopup(n),t.addTo(u)}})),u.addTo(e)))}function O(e,t,o){let n,l,a;if(e/=360,o/=100,0===(t/=100))n=l=a=o;else{const r=(e,t,o)=>(o<0&&(o+=1),o>1&&(o-=1),o<1/6?e+6*(t-e)*o:o<.5?t:o<2/3?e+(t-e)*(2/3-o)*6:e),i=o<.5?o*(1+t):o+t-o*t,s=2*o-i;n=r(s,i,e+1/3),l=r(s,i,e),a=r(s,i,e-1/3)}const r=e=>{const t=Math.round(255*e).toString(16);return 1===t.length?"0"+t:t};return`#${r(n)}${r(l)}${r(a)}`.toUpperCase()}b.addEventListener("change",(function(t){const o=t.target.files[0];if(!o)return;v.style.display="block";const n=new FileReader;n.onload=function(t){try{const n=t.target.result,l=XLSX.read(n,{type:"binary",cellDates:!0}),a=l.SheetNames[0],r=l.Sheets[a],i=XLSX.utils.sheet_to_json(r),s=new Set;let c=0;function o(){setTimeout((function(){const t=document.querySelector(".filter-bar"),o=document.querySelector(".controls-bar"),n=document.getElementById("toggleControlsBtn"),l=document.getElementById("toggle-controls-text");t.classList.add("collapsed"),o.classList.add("collapsed"),n.classList.add("collapsed"),l.textContent="Mostrar Controles",_=!1,setTimeout((function(){e.invalidateSize(),setTimeout((function(){e.invalidateSize(!0),R()}),100)}),450)}),500)}if(m=i.map((e=>{const t=e.latitud||e.LATITUD,o=e.longitud||e.LONGITUD,n=e.TIPO||e.tipo,l=e.FECHA||e.fecha,a=e.CALLE||e.calle||"Sin información",r=e.COLONIA||e.colonia||"Sin información",i=e.FOLIO||e.folio||e.ID||e.id||"Sin folio";n&&s.add(n);let d=parseFloat(t),p=parseFloat(o);const u=parseFloat(e.intensidad||1);!isNaN(p)&&p>0&&p>=86&&p<=118&&(console.warn(`⚠ Longitud positiva detectada y corregida: ${p} → ${-p}`),p=-p,c++);let g=null;return isNaN(d)||isNaN(p)||(g=[d,p,u]),{point:g,fecha:l instanceof Date?l:null,tipo:n,calle:a,colonia:r,folio:i}})).filter((e=>null!==e.point)),f=[...m],m.length>0){const d=m.map((e=>e.point[0])),u=m.map((e=>e.point[1]));console.log("=== DATOS CARGADOS ==="),console.log(`Total de puntos: ${m.length}`),console.log(`Rango Latitud: ${Math.min(...d).toFixed(6)} a ${Math.max(...d).toFixed(6)}`),console.log(`Rango Longitud: ${Math.min(...u).toFixed(6)} a ${Math.max(...u).toFixed(6)}`),c>0&&(console.warn(`⚠ ${c} coordenadas de longitud fueron corregidas (positivas → negativas)`),Alert.warning("Coordenadas Corregidas",`Se detectaron y corrigieron ${c} coordenadas con longitud positiva.\n\nEstas coordenadas han sido convertidas a negativas automáticamente.`).then((()=>{setTimeout((()=>{e.invalidateSize(!0),setTimeout((()=>{e.invalidateSize(!0),R(),setTimeout((()=>{o()}),100)}),100)}),300)})))}if(0===f.length)return Alert.error("Sin Datos Válidos","No se encontraron datos de coordenadas válidos en el archivo.").then((()=>{setTimeout((()=>{e.invalidateSize(!0)}),300)})),C.style.opacity="0.5",C.style.pointerEvents="none",E.style.opacity="0.5",E.style.pointerEvents="none",void(p&&e.removeLayer(p));$(A).data("select2")&&$(A).select2("destroy"),A.innerHTML="",s.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,A.appendChild(t)})),$(A).select2({placeholder:"Seleccionar tipo(s)",width:"200px",allowClear:!0}),C.style.opacity="1",C.style.pointerEvents="auto",E.style.opacity="1",E.style.pointerEvents="auto",b.style.display="none",document.getElementById("toggleControlsBtn").style.display="inline-block",R(),e.setView([19.702879635698825,-101.19232863317521],11),0===c&&o()}catch(g){console.error("Error al procesar el archivo:",g),Alert.error("Error al Procesar","Hubo un error al procesar el archivo. Verifica que el formato sea correcto.").then((()=>{setTimeout((()=>{e.invalidateSize(!0)}),300)}))}finally{v.style.display="none"}},n.onerror=function(t){console.error("Error al leer el archivo:",t),Alert.error("Error de Lectura","No se pudo leer el archivo. Intenta con otro archivo.").then((()=>{setTimeout((()=>{e.invalidateSize(!0)}),300)})),v.style.display="none"},n.readAsBinaryString(o)})),F.addEventListener("input",(function(){T.textContent=this.value,R()})),S.addEventListener("input",(function(){w.textContent=this.value,R()})),D.addEventListener("click",(function(){const e=x.value?new Date(x.value):null,t=I.value?new Date(I.value):null,o=Array.from(A.selectedOptions).map((e=>e.value)),n=B.value;e&&e.setHours(0,0,0,0),t&&t.setHours(23,59,59,999);let l=m;if(n&&y){let e=null;const t=n.trim().toLowerCase();console.log(`Buscando sector: "${n}" (normalizado: "${t}")`),y.eachLayer((function(o){const n=o.feature.properties.nombre||"Sin nombre";n.trim().toLowerCase()===t&&(console.log(`✓ Sector encontrado: "${n}"`),e=o)})),e?l=M(e):console.warn(`✗ No se encontró el sector: "${n}"`)}f=l.filter((n=>{let l=!0;if(n.fecha){const o=n.fecha;e&&o<e&&(l=!1),t&&o>t&&(l=!1)}let a=!0;return o.length>0&&(a=o.includes(n.tipo)),l&&a})),R()})),document.getElementById("toggleCuadrantes").addEventListener("change",(function(t){t.target.checked?e.addLayer(o):e.removeLayer(o)})),document.getElementById("toggleSectores").addEventListener("change",(function(t){t.target.checked?e.addLayer(r):e.removeLayer(r)}));const z=document.getElementById("sectoresOpacity"),P=document.getElementById("opacity-value");z.addEventListener("input",(function(){const e=parseInt(this.value,10);P.textContent=e;const t=e/100;r.eachLayer((function(e){e.setStyle&&e.setStyle({fillOpacity:t})}))}));const H=document.getElementById("toggleViewMode"),U=document.getElementById("view-mode-text"),G=document.getElementById("radius-control"),j=document.getElementById("blur-control");H.addEventListener("click",(function(){g=!g,g?(U.textContent="Calor",G.style.display="block",j.style.display="block"):(U.textContent="Marcadores",G.style.display="none",j.style.display="none"),R()})),B.addEventListener("change",(function(){const t=this.value;t&&y&&y.eachLayer((function(o){if((o.feature.properties.nombre||"Sin nombre")===t){const t=o.getBounds();e.fitBounds(t,{padding:[50,50]})}}))}));const X=document.getElementById("toggleControlsBtn"),K=document.getElementById("toggle-controls-text"),W=document.querySelector(".filter-bar"),V=document.querySelector(".controls-bar");let _=!0;X.addEventListener("click",(function(){_=!_,_?(W.classList.remove("collapsed"),V.classList.remove("collapsed"),X.classList.remove("collapsed"),K.textContent="Ocultar Controles"):(W.classList.add("collapsed"),V.classList.add("collapsed"),X.classList.add("collapsed"),K.textContent="Mostrar Controles"),setTimeout((function(){e.invalidateSize()}),450)}))}));